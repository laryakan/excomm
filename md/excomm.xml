<?xml version="1.0" encoding="utf-8"?>
<mdscript name="ExtendedComm" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
	<cues>
		<cue name="Add_Interact_Actions" instantiate="true">
		  <conditions>
			<event_cue_signalled cue="md.Interact_Menu_API.Get_Actions" />
		  </conditions>
			<actions>
			<set_value name="$target" exact="event.param.$object"/>
				<!-- List of condition to met to add the ExComm button
					open interaction menu outside the map menu
					player is actually piloting
					target is destrucible (and not already destroyed)
					target is a ship
				-->
				<do_if value="event.param.$showPlayerInteractions and player.controlled.isclass.ship and $target.isclass.{class.destructible} and $target.isclass.ship">
					<!-- add the button, vanilla icons are listed in libraries/icons.xml, for this one, search an icon 32*32 -->
					<signal_cue_instantly
						cue="md.Interact_Menu_API.Add_Action"
						param = "table[
						$id         = 'excom_interact',
						$section    = 'interaction',
						$text       = 'Extended Comm',
						$mouseover  = '%s %s'.['Extended Comm', $target.name],
						$icon       = 'missiontype_scan',
						$mouseover_icon = 'missiontype_scan',
						$callback   = excomm_effect,
						]"/>
				</do_if>
				<!-- reset listener after this cue instance is destroyed -->
				<reset_cue cue="this" />
			</actions>
		</cue>
		<!-- cue to add a little effect -->
		<cue name="excomm_effect">
			<conditions>
				<event_cue_signalled />
				<!-- cue must be triggered with a param object -->
				<check_value value="event.param.$object"/>
				<!-- param object must be a ship -->
				<check_value value="event.param.$object.isclass.ship"/>
			</conditions>
			<actions>
				<!-- targetted ship -->
				<set_value name="$TargetShip" exact="event.param.$object" />
				<debug_text text="'ExtendedComm -  Trigger on: ' + $TargetShip" />

				<!-- Betty - will try to find a better line -->
				<speak actor="player.computer" caninterrupt="false" line="30292010" comment="I'm on it..." />
				<play_sound sound="ui_modes_scan_long_on" type="ui" />
				<!-- Setting special cockpit tint for the time of the convo -->
				<set_cockpit_tint
					r="50"
					g="150"
					b="150"
					sethudcolors="true"
				/>

				<show_notification text="'Engaging long range comm beam...'"/>

				<!-- call convo initializer -->
				<signal_cue_instantly cue="excomm_convo" param="$TargetShip" />

				<!-- reset cockpit -->
				<set_cockpit_tint resettodefault="true" sethudcolors="true" />
				<play_sound sound="ui_modes_scan_long_off" type="ui" />

				<!-- reset listener after this cue instance is destroyed -->
				<reset_cue cue="this" />
			</actions>
		</cue>

		<!-- cue initiating convo -->
		<cue name="excomm_convo">
			<conditions>
				<event_cue_signalled />
				<!-- param must be a ship -->
				<check_value value="event.param.isclass.ship"/>
			</conditions>
			<!-- adding a delay to simulate comm establishing -->
			<delay min="1s" max="3s"/>
			<actions>
				<!-- to add special effect on ui, check ou md/modes.xml -->
				<!-- targetted ship -->
				<set_value name="$TargetShip" exact="event.param" />

				<show_notification text="'- ExComm established -'"/>

				<!-- Start default conversation-->
				<start_conversation actor="$TargetShip.pilot" conversation="default"/>

				<!-- reset listener after this cue instance is destroyed -->
				<reset_cue cue="this" />
			</actions>
		</cue>
	</cues>
</mdscript>
